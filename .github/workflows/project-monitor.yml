name: Monitor GitHub Project Moves

on:
  schedule:
    - cron: "*/5 * * * *" # Runs every 5 minutes
  workflow_dispatch:

jobs:
  check_project:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure Last PR Move File Exists
        run: |
          mkdir -p /tmp
          LAST_PR_MOVE="/tmp/last_pr_move.json"
          if [ ! -f "$LAST_PR_MOVE" ]; then
            echo "⚠️ No previous PR move state found. Creating a new one."
            echo '{}' > "$LAST_PR_MOVE"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Attempt to Download Last PR Move Artifact
        continue-on-error: true
        run: |
          echo "🔍 Attempting to download last PR move artifact..."
          if gh api repos/${{ github.repository }}/actions/artifacts --paginate | jq -e '.artifacts | map(select(.name == "last-pr-move")) | length > 0' >/dev/null; then
            echo "✅ Artifact exists, downloading..."
            gh run download -n last-pr-move -D /tmp || echo "⚠️ Failed to download artifact, continuing without it."
          else
            echo "⚠️ No previous artifact found. Proceeding without it."
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Load Last PR Move State
        run: |
          LAST_PR_MOVE="/tmp/last_pr_move.json"

          if [ -f "$LAST_PR_MOVE" ]; then
            echo "✅ Found previous PR move state:"
            cat "$LAST_PR_MOVE"
          else
            echo "⚠️ No previous PR move state found. Creating a new one."
            echo '{}' > "$LAST_PR_MOVE"
          fi

          echo "LAST_PR_MOVE=$LAST_PR_MOVE" >> $GITHUB_ENV

      - name: Query GitHub Project for Moved Cards
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PROJECT_ID: "PVT_kwHOAxVMgM4AxMpK"
        run: |
          echo "Fetching project data..."
          QUERY='
          {
            node(id: "'"$PROJECT_ID"'") {
              ... on ProjectV2 {
                id
                fields(first: 20) {
                  nodes {
                    ... on ProjectV2SingleSelectField {
                      name
                      options {
                        id
                        name
                        description
                      }
                    }
                  }
                }
                items(first: 10) {
                  nodes {
                    id
                    content {
                      ... on PullRequest {
                        title
                        url
                      }
                    }
                    fieldValues(first: 10) {
                      nodes {
                        __typename
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          optionId
                        }
                      }
                    }
                  }
                }
              }
            }
          }'
          RESPONSE=$(gh api graphql -f query="$QUERY")

          echo "GraphQL Response: $RESPONSE"

          PR_TITLE=$(echo "$RESPONSE" | jq -r '.data.node.items.nodes[0].content.title')
          PR_LINK=$(echo "$RESPONSE" | jq -r '.data.node.items.nodes[0].content.url')
          COLUMN_NAME=$(echo "$RESPONSE" | jq -r '.data.node.items.nodes[0].fieldValues.nodes[] | select(.__typename=="ProjectV2ItemFieldSingleSelectValue") | .name')
          OPTION_ID=$(echo "$RESPONSE" | jq -r '.data.node.items.nodes[0].fieldValues.nodes[] | select(.__typename=="ProjectV2ItemFieldSingleSelectValue") | .optionId')

          # ✅ Fix column description retrieval
          COLUMN_DESCRIPTION=$(echo "$RESPONSE" | jq -r --arg optionId "$OPTION_ID" '
            .data.node.fields.nodes[] 
            | select(.name=="Status") 
            | .options[] 
            | select(.id==$optionId) 
            | .description // "No description available."')

          # ✅ Ensure values are set
          if [[ -z "$COLUMN_NAME" || "$COLUMN_NAME" == "null" ]]; then
            COLUMN_NAME="Unknown Column"
          fi

          if [[ -z "$COLUMN_DESCRIPTION" || "$COLUMN_DESCRIPTION" == "null" ]]; then
            COLUMN_DESCRIPTION="No description available."
          fi

          # ✅ Load last PR move state and compare
          LAST_PR_MOVE="${{ env.LAST_PR_MOVE }}"
          if [ -f "$LAST_PR_MOVE" ]; then
            LAST_PR_TITLE=$(jq -r '.title' "$LAST_PR_MOVE")
            LAST_COLUMN_NAME=$(jq -r '.column' "$LAST_PR_MOVE")

            echo "🔍 Previous PR: $LAST_PR_TITLE was in column: $LAST_COLUMN_NAME"
            echo "🔍 Current PR: $PR_TITLE is in column: $COLUMN_NAME"

            if [[ "$PR_TITLE" == "$LAST_PR_TITLE" && "$COLUMN_NAME" == "$LAST_COLUMN_NAME" ]]; then
              echo "✅ No PR move detected. Exiting."
              exit 0  # Prevents unnecessary email
            fi
          fi

          # ✅ Save new PR move state
          echo "{\"title\": \"$PR_TITLE\", \"column\": \"$COLUMN_NAME\"}" > "$LAST_PR_MOVE"

          if [ -f "$LAST_PR_MOVE" ]; then
            chmod 644 "$LAST_PR_MOVE"
          fi

          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "PR_LINK=$PR_LINK" >> $GITHUB_ENV
          echo "COLUMN_NAME=$COLUMN_NAME" >> $GITHUB_ENV
          echo "COLUMN_DESCRIPTION=$COLUMN_DESCRIPTION" >> $GITHUB_ENV
          echo "✅ Detected PR: $PR_TITLE moved to $COLUMN_NAME - $COLUMN_DESCRIPTION"

      - name: Upload Last PR Move (Ensure Persistence)
        uses: actions/upload-artifact@v4
        with:
          name: last-pr-move
          path: /tmp/last_pr_move.json
          retention-days: 7
          if-no-files-found: warn # ✅ Warn instead of failing

      - name: Send Email via SendGrid API (GitHub Script)
        uses: actions/github-script@v6
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        with:
          script: |
            const columnName = (process.env.COLUMN_NAME || "unknown-column")
              .toLowerCase()   
              .replace(/\s+/g, '-') 
              .replace(/[^a-z0-9-]/g, '');
            const columnDescription = process.env.COLUMN_DESCRIPTION || "No description available.";

            // ✅ Dynamic email mapping based on column name
            const columnEmailMapping = {
              "cip-announce": "amartin@linuxfoundation.org",
              "cip-vote": "amanda@riscv.org",
              "cip-discuss": "amanda@r-consortium.org",
              "draft": "amartin@linuxfoundation.org"
            };

            const emailRecipient = columnEmailMapping[columnName] || `amartin@linuxfoundation.org`;
            const subject = `${process.env.PR_TITLE} is in ${columnName}`;
            const body = `Hello,\n\n${process.env.PR_TITLE} ${columnDescription}\n\nLink to PR: ${process.env.PR_LINK}\n\nPlease let us know if you have any questions or concerns.`;

            const payload = {
              personalizations: [{
                to: [{ email: emailRecipient }]
              }],
              from: { email: "amartin@linuxfoundation.org" },
              subject: subject,
              content: [{
                type: "text/plain",
                value: body
              }],
              tracking_settings: {
                click_tracking: { enable: false }
              }
            };

            console.log(`📤 Sending email to: ${emailRecipient}`);
            console.log("📤 Sending email with this JSON payload:");
            console.log(JSON.stringify(payload, null, 2));

            const response = await fetch("https://api.sendgrid.com/v3/mail/send", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.SENDGRID_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify(payload)
            });

            console.log(`📨 SendGrid Response Status: ${response.status}`);
            console.log(`📨 SendGrid Response Body:`, await response.text());

            if (!response.ok) {
              process.exit(1);
            }
